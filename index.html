<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Online Mafia Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .hidden { display: none; }
        .card {
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .btn-primary {
            @apply bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-indigo-700 transition-all duration-200;
        }
        .btn-secondary {
            @apply bg-gray-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 transition-all duration-200;
        }
        .btn-danger {
            @apply bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-700 transition-all duration-200;
        }
        .input-field {
            @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500;
        }
    </style>
</head>
<body class="bg-gray-900 text-white flex items-center justify-center min-h-screen">

    <div id="app-container" class="w-full max-w-md mx-auto p-4">

        <!-- Initial Screen: Create or Join Game -->
        <div id="initial-screen" class="text-center space-y-4">
            <h1 class="text-5xl font-bold text-indigo-400">MAFIA</h1>
            <p class="text-gray-400">The Online Social Deduction Game</p>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <input id="username-input" type="text" placeholder="Enter your name" class="input-field text-black text-center mb-4">
                <button id="create-game-btn" class="btn-primary w-full mb-2">Create New Game</button>
                <button id="join-game-view-btn" class="btn-secondary w-full">Join Existing Game</button>
            </div>
        </div>
        
        <!-- Join Game Screen -->
        <div id="join-game-screen" class="hidden text-center space-y-4">
             <h2 class="text-3xl font-bold text-indigo-400">Join Game</h2>
             <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <input id="game-code-input" type="text" placeholder="Enter 4-letter game code" class="input-field text-black text-center mb-4 uppercase" maxlength="4">
                <button id="join-game-btn" class="btn-primary w-full mb-2">Join Game</button>
                <button id="back-to-main-btn" class="btn-secondary w-full">Back</button>
            </div>
        </div>

        <!-- Lobby Screen -->
        <div id="lobby-screen" class="hidden space-y-4">
            <h2 class="text-3xl font-bold text-center text-indigo-400">Lobby</h2>
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg text-center">
                <p class="text-gray-400">Share this code with your friends:</p>
                <div id="game-code-display" class="text-4xl font-bold tracking-widest bg-gray-700 p-2 rounded-lg my-2 cursor-pointer" title="Click to copy">
                    ----
                </div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                <h3 class="text-xl font-semibold mb-2 text-center">Players (<span id="player-count">0</span>)</h3>
                <ul id="player-list" class="space-y-2">
                    <!-- Player items will be injected here -->
                </ul>
            </div>
            <button id="start-game-btn" class="btn-primary w-full hidden">Start Game</button>
        </div>

        <!-- Game Screen -->
        <div id="game-screen" class="hidden w-full max-w-lg mx-auto p-4 space-y-4">
            <!-- Game Header -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg flex justify-between items-center">
                <div>
                    <h2 id="game-phase-display" class="text-2xl font-bold text-indigo-400"></h2>
                    <p id="day-number-display" class="text-gray-400"></p>
                </div>
                <div class="text-right">
                    <p class="font-semibold">Your Role:</p>
                    <p id="player-role-display" class="text-xl font-bold"></p>
                </div>
            </div>
            
            <!-- Message/Announcement Area -->
            <div id="announcement-area" class="bg-indigo-900/50 p-4 rounded-lg text-center hidden">
                <p id="announcement-message" class="text-lg"></p>
            </div>

            <!-- Player Grid -->
            <div class="bg-gray-800 p-4 rounded-lg shadow-lg">
                 <h3 class="text-xl font-semibold mb-3 text-center">Living Players</h3>
                 <div id="game-player-grid" class="grid grid-cols-2 sm:grid-cols-3 gap-4">
                    <!-- Player cards will be injected here -->
                 </div>
            </div>
            
             <!-- Action Area -->
            <div id="action-area" class="bg-gray-800 p-4 rounded-lg shadow-lg text-center hidden">
                <p id="action-prompt" class="text-lg mb-4"></p>
                <button id="action-confirm-btn" class="btn-primary hidden"></button>
            </div>
        </div>
        
        <!-- Game Over Screen -->
        <div id="game-over-screen" class="hidden text-center space-y-4">
            <h2 class="text-4xl font-bold text-indigo-400">Game Over</h2>
            <div class="bg-gray-800 p-6 rounded-lg shadow-lg">
                <p id="winner-announcement" class="text-2xl mb-4"></p>
                <h3 class="text-xl font-semibold mb-2">Final Roles:</h3>
                <ul id="final-roles-list" class="space-y-1 text-left">
                    <!-- Final roles will be listed here -->
                </ul>
                <button id="play-again-btn" class="btn-primary w-full mt-6">Play Again</button>
            </div>
        </div>

    </div>

    <!-- Firebase -->
    <script type="module">
        // --- FIREBASE IMPORTS AND CONFIG ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, onSnapshot, collection, writeBatch } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: These global variables are provided by the execution environment.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'mafia-game-default';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- FIREBASE INITIALIZATION ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- GLOBAL STATE ---
        let currentUserId = null;
        let currentGameCode = null;
        let unsubscribeGameListener = null;
        let localGameState = {};

        // --- UI ELEMENTS ---
        const screens = {
            initial: document.getElementById('initial-screen'),
            join: document.getElementById('join-game-screen'),
            lobby: document.getElementById('lobby-screen'),
            game: document.getElementById('game-screen'),
            gameOver: document.getElementById('game-over-screen'),
        };

        // --- AUTHENTICATION ---
        async function initializeAuth() {
            try {
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Authentication failed:", error);
                // Using a custom modal/div for alerts is better, but alert is used for simplicity here.
                const userAlert = document.createElement('div');
                userAlert.textContent = "Could not connect to the server. Please refresh the page.";
                userAlert.style.cssText = "position:fixed;top:10px;left:50%;transform:translateX(-50%);background:red;color:white;padding:10px;border-radius:5px;z-index:1000;";
                document.body.appendChild(userAlert);
                setTimeout(() => userAlert.remove(), 3000);
            }
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUserId = user.uid;
                console.log("Authenticated with user ID:", currentUserId);
            } else {
                console.log("User is signed out.");
            }
        });

        // --- UI NAVIGATION ---
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            if (screens[screenName]) {
                screens[screenName].classList.remove('hidden');
            }
        }
        
        // --- EVENT LISTENERS ---
        document.getElementById('create-game-btn').addEventListener('click', createGame);
        document.getElementById('join-game-view-btn').addEventListener('click', () => showScreen('join'));
        document.getElementById('back-to-main-btn').addEventListener('click', () => showScreen('initial'));
        document.getElementById('join-game-btn').addEventListener('click', joinGame);
        document.getElementById('start-game-btn').addEventListener('click', startGame);
        document.getElementById('game-code-display').addEventListener('click', copyGameCode);
        document.getElementById('play-again-btn').addEventListener('click', () => {
            if (unsubscribeGameListener) unsubscribeGameListener();
            resetLocalState();
            showScreen('initial');
        });


        // --- GAME LOGIC ---

        function getUsername() {
            const username = document.getElementById('username-input').value.trim();
            if (!username) {
                alert("Please enter a name.");
                return null;
            }
            return username;
        }

        async function createGame() {
            const username = getUsername();
            if (!username || !currentUserId) return;

            const gameCode = generateGameCode();
            currentGameCode = gameCode;
            const gameRef = doc(db, `artifacts/${appId}/public/data/mafiaGames`, gameCode);

            const newPlayer = {
                userId: currentUserId,
                name: username,
                isAlive: true,
                role: 'Unassigned',
                votes: 0,
            };

            const newGameData = {
                gameId: gameCode,
                hostId: currentUserId,
                players: [newPlayer],
                gameState: 'lobby',
                dayNumber: 1,
                nightActions: {},
                votes: {},
                announcement: '',
                winner: null,
            };

            try {
                await setDoc(gameRef, newGameData);
                listenToGameUpdates(gameCode);
                showScreen('lobby');
            } catch (error) {
                console.error("Error creating game:", error);
                alert("Could not create game. Please try again.");
            }
        }

        async function joinGame() {
            const username = getUsername();
            if (!username) return;
            
            const gameCode = document.getElementById('game-code-input').value.trim().toUpperCase();
            if (gameCode.length !== 4) {
                alert("Please enter a valid 4-letter game code.");
                return;
            }

            const gameRef = doc(db, `artifacts/${appId}/public/data/mafiaGames`, gameCode);
            try {
                const gameSnap = await getDoc(gameRef);
                if (!gameSnap.exists()) {
                    alert("Game not found.");
                    return;
                }

                const gameData = gameSnap.data();
                if (gameData.gameState !== 'lobby') {
                    alert("This game has already started.");
                    return;
                }
                
                if (gameData.players.some(p => p.userId === currentUserId)) {
                     // Player is rejoining, just listen
                } else {
                    const newPlayer = {
                        userId: currentUserId,
                        name: username,
                        isAlive: true,
                        role: 'Unassigned',
                        votes: 0,
                    };
                    const updatedPlayers = [...gameData.players, newPlayer];
                    await updateDoc(gameRef, { players: updatedPlayers });
                }

                currentGameCode = gameCode;
                listenToGameUpdates(gameCode);
                showScreen('lobby');

            } catch (error) {
                console.error("Error joining game:", error);
                alert("Could not join game. Please check the code and try again.");
            }
        }
        
        function listenToGameUpdates(gameCode) {
            if (unsubscribeGameListener) {
                unsubscribeGameListener();
            }
            const gameRef = doc(db, `artifacts/${appId}/public/data/mafiaGames`, gameCode);
            unsubscribeGameListener = onSnapshot(gameRef, (doc) => {
                if (doc.exists()) {
                    const gameData = doc.data();
                    localGameState = gameData; // Store latest state
                    updateUI(gameData);
                } else {
                    alert("The game has ended or was deleted.");
                    if (unsubscribeGameListener) unsubscribeGameListener();
                    resetLocalState();
                    showScreen('initial');
                }
            });
        }

        function updateUI(gameData) {
            // Update based on gameState
            switch (gameData.gameState) {
                case 'lobby':
                    updateLobbyUI(gameData);
                    showScreen('lobby');
                    break;
                case 'night':
                case 'day':
                    updateGameUI(gameData);
                    showScreen('game');
                    break;
                case 'game-over':
                    updateGameOverUI(gameData);
                    showScreen('gameOver');
                    break;
            }
        }
        
        function updateLobbyUI(gameData) {
            document.getElementById('game-code-display').textContent = gameData.gameId;
            document.getElementById('player-count').textContent = gameData.players.length;
            
            const playerList = document.getElementById('player-list');
            playerList.innerHTML = '';
            gameData.players.forEach(player => {
                const li = document.createElement('li');
                li.className = 'bg-gray-700 p-2 rounded-md flex justify-between items-center';
                li.textContent = player.name;
                if (player.userId === gameData.hostId) {
                    const hostTag = document.createElement('span');
                    hostTag.className = 'text-xs bg-indigo-500 px-2 py-1 rounded-full';
                    hostTag.textContent = 'Host';
                    li.appendChild(hostTag);
                }
                playerList.appendChild(li);
            });
            
            const startGameBtn = document.getElementById('start-game-btn');
            if (gameData.hostId === currentUserId) {
                startGameBtn.classList.remove('hidden');
                if (gameData.players.length < 3) { // Minimum players to start
                    startGameBtn.disabled = true;
                    startGameBtn.textContent = 'Need at least 3 players';
                    startGameBtn.classList.add('opacity-50', 'cursor-not-allowed');
                } else {
                    startGameBtn.disabled = false;
                    startGameBtn.textContent = 'Start Game';
                    startGameBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            } else {
                startGameBtn.classList.add('hidden');
            }
        }

        async function startGame() {
            if (localGameState.hostId !== currentUserId) return;
            
            const players = localGameState.players;
            const roles = assignRoles(players.length);
            const shuffledPlayers = [...players].sort(() => Math.random() - 0.5);

            for (let i = 0; i < shuffledPlayers.length; i++) {
                shuffledPlayers[i].role = roles[i];
            }

            const gameRef = doc(db, `artifacts/${appId}/public/data/mafiaGames`, currentGameCode);
            try {
                await updateDoc(gameRef, {
                    players: shuffledPlayers,
                    gameState: 'night',
                    announcement: 'The first night begins... Silence falls over the town.'
                });
            } catch (error) {
                console.error("Error starting game:", error);
            }
        }

        function assignRoles(playerCount) {
            // This is a basic role distribution. You can make this more complex.
            let roles = [];
            if (playerCount < 5) { // 3-4 players
                roles.push('Mafia');
                roles.push('Sheriff');
                roles.push('Doctor');
            } else if (playerCount < 7) { // 5-6 players
                roles.push('Mafia', 'Mafia');
                roles.push('Sheriff');
                roles.push('Doctor');
            } else { // 7+ players
                roles.push('Mafia', 'Mafia');
                roles.push('Sheriff');
                roles.push('Doctor');
            }
            while (roles.length < playerCount) {
                roles.push('Townsperson');
            }
            return roles.sort(() => Math.random() - 0.5); // Shuffle roles
        }
        
        function updateGameUI(gameData) {
            const me = gameData.players.find(p => p.userId === currentUserId);
            if (!me) return; // Spectator or error

            document.getElementById('day-number-display').textContent = `Day ${gameData.dayNumber}`;
            document.getElementById('player-role-display').textContent = me.role;
            document.getElementById('game-phase-display').textContent = gameData.gameState.toUpperCase();
            
            const announcementArea = document.getElementById('announcement-area');
            const announcementMessage = document.getElementById('announcement-message');
            if (gameData.announcement) {
                announcementMessage.textContent = gameData.announcement;
                announcementArea.classList.remove('hidden');
            } else {
                announcementArea.classList.add('hidden');
            }

            const playerGrid = document.getElementById('game-player-grid');
            playerGrid.innerHTML = '';
            const livingPlayers = gameData.players.filter(p => p.isAlive);

            livingPlayers.forEach(player => {
                const card = document.createElement('button');
                card.className = 'card bg-gray-700 p-3 rounded-lg text-center';
                card.dataset.userId = player.userId;
                card.innerHTML = `<div class="font-semibold">${player.name}</div>`;
                
                // Add vote count during the day
                if (gameData.gameState === 'day') {
                    const votesForPlayer = Object.values(gameData.votes || {}).filter(v => v === player.userId).length;
                    if (votesForPlayer > 0) {
                        card.innerHTML += `<div class="text-xs mt-1 bg-red-500 rounded-full px-2">${votesForPlayer} Vote(s)</div>`;
                    }
                }
                
                playerGrid.appendChild(card);
            });
            
            handlePlayerActions(gameData, me);
        }

        function handlePlayerActions(gameData, me) {
            const actionArea = document.getElementById('action-area');
            const actionPrompt = document.getElementById('action-prompt');
            const playerGrid = document.getElementById('game-player-grid');
            let actionType = null;
            let promptText = '';
            let eligibleTargets = [];

            if (!me.isAlive) {
                actionArea.classList.add('hidden');
                playerGrid.querySelectorAll('button').forEach(b => b.disabled = true);
                return;
            }

            if (gameData.gameState === 'night') {
                const nightActions = gameData.nightActions || {};
                switch (me.role) {
                    case 'Mafia':
                        if (!nightActions.mafiaTarget) {
                            actionType = 'mafiaKill';
                            promptText = 'Choose a player to eliminate.';
                            eligibleTargets = gameData.players.filter(p => p.isAlive && p.role !== 'Mafia');
                        } else {
                             promptText = 'The Mafia has chosen. Waiting for others...';
                        }
                        break;
                    case 'Doctor':
                         if (!nightActions.doctorSave) {
                            actionType = 'doctorSave';
                            promptText = 'Choose a player to save.';
                            eligibleTargets = gameData.players.filter(p => p.isAlive);
                        } else {
                            promptText = 'You have made your choice. Waiting for others...';
                        }
                        break;
                    case 'Sheriff':
                         if (!nightActions.sheriffCheck) {
                            actionType = 'sheriffCheck';
                            promptText = 'Choose a player to investigate.';
                            eligibleTargets = gameData.players.filter(p => p.isAlive && p.userId !== currentUserId);
                        } else {
                             const checkedPlayer = gameData.players.find(p => p.userId === nightActions.sheriffCheck);
                             promptText = `You investigated ${checkedPlayer.name}. They are ${checkedPlayer.role === 'Mafia' ? 'MAFIA' : 'NOT MAFIA'}.`;
                        }
                        break;
                    default:
                        promptText = 'You sleep soundly through the night...';
                }
            } else if (gameData.gameState === 'day') {
                const votes = gameData.votes || {};
                if (!votes[currentUserId]) {
                    actionType = 'vote';
                    promptText = 'Discuss and vote to eliminate a player.';
                    eligibleTargets = gameData.players.filter(p => p.isAlive);
                } else {
                    const votedPlayer = gameData.players.find(p => p.userId === votes[currentUserId]);
                    promptText = `You have voted for ${votedPlayer.name}. Waiting for others to vote.`;
                }
            }

            if (promptText) {
                actionPrompt.textContent = promptText;
                actionArea.classList.remove('hidden');
            } else {
                actionArea.classList.add('hidden');
            }
            
            // Enable/disable player cards for actions
            playerGrid.querySelectorAll('button').forEach(card => {
                const cardUserId = card.dataset.userId;
                const isEligible = eligibleTargets.some(p => p.userId === cardUserId);
                card.disabled = !isEligible;
                card.onclick = isEligible ? () => handleCardClick(cardUserId, actionType) : null;
                card.classList.toggle('opacity-50', !isEligible);
                card.classList.toggle('cursor-pointer', isEligible);
                card.classList.toggle('hover:bg-indigo-500', isEligible);
            });
            
            // Host processes game state transitions
            if (localGameState.hostId === currentUserId) {
                checkAndProcessPhaseEnd(gameData);
            }
        }
        
        async function handleCardClick(targetUserId, actionType) {
            if (!actionType) return;
            
            const gameRef = doc(db, `artifacts/${appId}/public/data/mafiaGames`, currentGameCode);
            let updatePayload = {};

            if (actionType === 'mafiaKill') {
                updatePayload['nightActions.mafiaTarget'] = targetUserId;
            } else if (actionType === 'doctorSave') {
                updatePayload['nightActions.doctorSave'] = targetUserId;
            } else if (actionType === 'sheriffCheck') {
                updatePayload['nightActions.sheriffCheck'] = targetUserId;
            } else if (actionType === 'vote') {
                updatePayload[`votes.${currentUserId}`] = targetUserId;
            }
            
            try {
                await updateDoc(gameRef, updatePayload);
            } catch (error) {
                console.error('Error submitting action:', error);
            }
        }
        
        let isProcessing = false; // Debounce flag for host
        async function checkAndProcessPhaseEnd(gameData) {
            if (isProcessing) return;
            isProcessing = true;
            
            const livingPlayers = gameData.players.filter(p => p.isAlive);
            const nightActions = gameData.nightActions || {};
            
            if (gameData.gameState === 'night') {
                const mafiaDone = !!nightActions.mafiaTarget;
                const doctorDone = !livingPlayers.some(p => p.role === 'Doctor') || !!nightActions.doctorSave;
                const sheriffDone = !livingPlayers.some(p => p.role === 'Sheriff') || !!nightActions.sheriffCheck;

                if (mafiaDone && doctorDone && sheriffDone) {
                    await processNight(gameData);
                }
            } else if (gameData.gameState === 'day') {
                const votes = gameData.votes || {};
                const livingPlayerIds = livingPlayers.map(p => p.userId);
                const votesCast = Object.keys(votes).filter(voterId => livingPlayerIds.includes(voterId)).length;
                
                if (votesCast === livingPlayers.length) {
                    await processDay(gameData);
                }
            }
            
            isProcessing = false;
        }
        
        async function processNight(gameData) {
            const { nightActions, players } = gameData;
            let killedPlayer = null;
            let announcement = '';
            
            if (nightActions.mafiaTarget && nightActions.mafiaTarget !== nightActions.doctorSave) {
                killedPlayer = players.find(p => p.userId === nightActions.mafiaTarget);
            }
            
            const updatedPlayers = players.map(p => {
                if (killedPlayer && p.userId === killedPlayer.userId) {
                    return { ...p, isAlive: false };
                }
                return p;
            });

            if (killedPlayer) {
                announcement = `A shadow fell over the town. ${killedPlayer.name} was found dead. They were a ${killedPlayer.role}.`;
            } else {
                announcement = "The town was quiet. No one died last night.";
            }
            
            const winner = checkWinCondition(updatedPlayers);

            const gameRef = doc(db, `artifacts/${appId}/public/data/mafiaGames`, currentGameCode);
            await updateDoc(gameRef, {
                players: updatedPlayers,
                gameState: winner ? 'game-over' : 'day',
                winner: winner,
                announcement: announcement,
            });
        }
        
        async function processDay(gameData) {
            const { votes, players } = gameData;
            const voteCounts = {};
            Object.values(votes).forEach(targetId => {
                voteCounts[targetId] = (voteCounts[targetId] || 0) + 1;
            });
            
            let maxVotes = 0;
            let playersToEliminate = [];
            for (const userId in voteCounts) {
                if (voteCounts[userId] > maxVotes) {
                    maxVotes = voteCounts[userId];
                    playersToEliminate = [userId];
                } else if (voteCounts[userId] === maxVotes) {
                    playersToEliminate.push(userId);
                }
            }

            let eliminatedPlayer = null;
            let announcement = '';

            if (playersToEliminate.length === 1 && maxVotes > 0) {
                eliminatedPlayer = players.find(p => p.userId === playersToEliminate[0]);
            }
            
            const updatedPlayers = players.map(p => {
                if (eliminatedPlayer && p.userId === eliminatedPlayer.userId) {
                    return { ...p, isAlive: false };
                }
                return p;
            });
            
            if (eliminatedPlayer) {
                announcement = `The town has spoken! ${eliminatedPlayer.name} has been eliminated. They were a ${eliminatedPlayer.role}.`;
            } else {
                announcement = "The vote was tied. No one was eliminated.";
            }
            
            const winner = checkWinCondition(updatedPlayers);
            
            const gameRef = doc(db, `artifacts/${appId}/public/data/mafiaGames`, currentGameCode);
            await updateDoc(gameRef, {
                players: updatedPlayers,
                gameState: winner ? 'game-over' : 'night',
                winner: winner,
                dayNumber: gameData.dayNumber + 1,
                announcement: announcement,
                nightActions: {}, // Reset for next night
                votes: {}, // Reset for next day
            });
        }
        
        function checkWinCondition(players) {
            const livingPlayers = players.filter(p => p.isAlive);
            const mafiaCount = livingPlayers.filter(p => p.role === 'Mafia').length;
            const townCount = livingPlayers.length - mafiaCount;

            if (mafiaCount === 0) {
                return 'Town';
            }
            if (mafiaCount >= townCount) {
                return 'Mafia';
            }
            return null;
        }
        
        function updateGameOverUI(gameData) {
            document.getElementById('winner-announcement').textContent = `The ${gameData.winner} team wins!`;
            const finalRolesList = document.getElementById('final-roles-list');
            finalRolesList.innerHTML = '';
            gameData.players.forEach(player => {
                const li = document.createElement('li');
                li.textContent = `${player.name} was a ${player.role}`;
                finalRolesList.appendChild(li);
            });
        }

        // --- UTILITY FUNCTIONS ---
        function generateGameCode() {
            return 'ABCDEFGHIJKLMNOPQRSTUVWXYZ'.split('').sort(() => 0.5 - Math.random()).slice(0, 4).join('');
        }
        
        function copyGameCode() {
            const code = document.getElementById('game-code-display').textContent;
            // Using document.execCommand for broader compatibility in sandboxed environments
            const textArea = document.createElement("textarea");
            textArea.value = code;
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();
            try {
                document.execCommand('copy');
                alert(`Game code "${code}" copied to clipboard!`);
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }
            document.body.removeChild(textArea);
        }
        
        function resetLocalState() {
            currentUserId = auth.currentUser ? auth.currentUser.uid : null;
            currentGameCode = null;
            unsubscribeGameListener = null;
            localGameState = {};
            document.getElementById('username-input').value = '';
            document.getElementById('game-code-input').value = '';
        }

        // --- APP INITIALIZATION ---
        async function init() {
            await initializeAuth();
            showScreen('initial');
        }

        init();

    </script>
</body>
</html>
